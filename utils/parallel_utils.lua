local ffi=require 'ffi'
require 'cutorch'
require 'cunn'

function makeDataParallel(model, nGPU)
  if nGPU > 1 then
    print('converting module to nn.DataParallelTable')
    assert(nGPU <= cutorch.getDeviceCount(), 
      'number of GPUs less than nGPU specified')
    local model_single = model
    model = nn.DataParallelTable(1)
    for i=1, opt.nGPU do
      cutorch.setDevice(i)
      model:add(model_single:clone():cuda(), i)
    end
    cutorch.setDevice(opt.GPU)
  end
  return model
end

